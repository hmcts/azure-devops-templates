parameters:
    - name: subscription
      type: string
    - name: keyVaultName
      type: string
    - name: ipList # Az DevOps agent outbound IPs - see https://learn.microsoft.com/en-us/azure/devops/organizations/security/allow-list-ip-url?view=azure-devops&tabs=IP-V4#outbound-connections
      type: object
      default:
      - '13.107.6.0/24'
      - '13.107.9.0/24'
      - '13.107.42.0/24'
      - '13.107.43.0/24'
      - '150.171.22.0/24'
      - '150.171.23.0/24'
      - '150.171.73.0/24'
      - '150.171.74.0/24'
      - '150.171.75.0/24'
      - '150.171.76.0/24'

steps:
    - task: AzureCLI@2
      displayName: Add FW Exception to ${{ parameters.keyVaultName }}
      inputs:
        azureSubscription: ${{ parameters.subscription }}
        scriptType: pscore
        scriptLocation: 'inlineScript'
        inlineScript: |
          $keyVaultName = "${{ parameters.keyVaultName }}"
          $ipList = "${{ convertToJson(parameters.ipList) }}" | ConvertFrom-Json
          Write-Host $ipList

          foreach ($ip in $ipList) {
            Write-Host "Adding IP address $ip to Key Vault firewall"
            az keyvault network-rule add --name $keyVaultName --ip-address "$ip"
          }

          $ready = 1; $retry = 0
          while($ready -ne 0 -and $retry -lt 10) {
            Start-Sleep (15 * $retry++)  
            try{          
              write-host "checking keyvault access"
              az keyvault secret list --vault-name $keyVaultName | out-null
              $ready = $LASTEXITCODE    
            } catch {
              $ready = 1
            }        
          }
