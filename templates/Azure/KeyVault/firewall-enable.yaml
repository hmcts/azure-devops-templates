parameters:
    - name: subscription
      type: string
    - name: keyVaultName
      type: string
    - name: resourceGroup
      type: string

steps:
    - task: AzureCLI@2
      displayName: Disable Public Access to ${{ parameters.keyVaultName }}
      inputs:
        azureSubscription: ${{ parameters.subscription }}
        scriptType: pscore
        scriptLocation: 'inlineScript'
        inlineScript: |
          $keyVaultName = "${{ parameters.keyVaultName }}"
          $resourceGroup = "${{ parameters.resourceGroup }}"
          Write-Host "Enabling KeyVault Firewall for $keyVaultName in $resourceGroup"          
          az keyvault update --name $keyVaultName --resource-group $resourceGroup --public-network-access Disabled --default-action Deny --bypass AzureServices
          
          $ready = 1; $retry = 0
          while($ready -ne 0 -and $retry -lt 10) {
            Start-Sleep (15 * $retry++)  
            try{          
              write-host "checking keyvault access.."
              az keyvault secret list --vault-name $keyVaultName | out-null
              $ready = $LASTEXITCODE    
            } catch {
              $ready = 1
            }        
          }
