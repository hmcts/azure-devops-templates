parameters:
  - name: subscription
    type: string
  - name: keyVaultName
    type: string
  - name: ipList # Az DevOps agent outbound IPs - see https://learn.microsoft.com/en-us/azure/devops/organizations/security/allow-list-ip-url?view=azure-devops&tabs=IP-V4#outbound-connections
    type: object
    default:
    - 13.107.6.0/24
    - 13.107.9.0/24
    - 13.107.42.0/24
    - 13.107.43.0/24
    - 150.171.22.0/24
    - 150.171.23.0/24
    - 150.171.73.0/24
    - 150.171.74.0/24
    - 150.171.75.0/24
    - 150.171.76.0/24

steps:
  - task: AzureCLI@2
    displayName: Remove FW Exception to ${{ parameters.keyVaultName }}
    condition: always()
    inputs:
      azureSubscription: ${{ parameters.subscription }}
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
          $keyVaultName = "${{ parameters.keyVaultName }}"
          $ipList = "${{ convertToJson(parameters.ipList) }}" | ConvertFrom-Json

          foreach ($ip in $env:ipList) {
            Write-Host "Removing IP address $ip from Key Vault firewall"
            try {
              az keyvault network-rule remove --name $env:keyVaultName --ip-address "$ip"
            } catch {
              Write-Host "Failed to remove IP address $ip. Continuing..."
            }
          }    